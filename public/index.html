<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="/static/css/bootstrap.min.css">

    <title>Callcenter Dashboard</title>
</head>
<body>

<div class="container-fluid">
    <div class="row">
        <div class="col-sm">
            <h3>Incoming calls</h3>
            <div id="callers"></div>
        </div>
        <div class="col-sm">
            <h3>Agents</h3>
            <div id="agents"></div>
        </div>
        <div class="col-sm">
            <h3>Connected calls</h3>
            <div id="connected"></div>
        </div>
    </div>
</div>

<script src="/static/js/jquery-3.3.1.min.js"></script>
<script src="/static/js/bootstrap.min.js"></script>

<script>
    var conn = new WebSocket('ws://callcenter.local:8080/callcenter');

    conn.onmessage = function(e) {
        console.log(e.data);

        let lines = e.data.split("\n");

        lines.forEach(function (val, index) {
            updateUI(val);
        })
    };

    conn.onopen = function (e) {
        conn.send('HELLO');
    };


    function changeStatus(agentid)
    {
        let str = 'TOGGLE:'+agentid;
        console.log(str);
        conn.send(str);
    }

    function goAvail(agentid)
    {
        let str = 'AVAIL:'+agentid;
        console.log(str);
        conn.send(str);
    }

    function updateUI(msg)
    {
        let parts = msg.split(":");
        let event = parts[0];

        switch (event) {
            case 'AGENT':
                handleAgentUI(event, parts[1]);
                break;
            case 'CALLER':
            case 'CALLERHANGUP':
            case 'CALLERJOIN':
                handleCallerUI(event, parts[1]);
                break;
            case 'CONNECT':
                handleConnectUI(event, parts[1], parts[2]);
                break;
            default:
                break;
        }
    }

    function handleConnectUI(event, agentinfo, callinfo)
    {
        let agentparts = agentinfo.split("|");
        let callparts = callinfo.split("|");

        let agent = agentparts[0];
        let caller = callparts[0];

        let id = "connect-"+callparts[2];

        let connection = $(id);

        let agentclass = "connectedagent-"+agent;

        if (!connection.length) {
            $('#connected').append(
                "<div class='alert alert-secondary' id='"+id+"'>Agent "+agent + " connected to call " + caller +"</div>"
            );
        }
    }

    function handleCallerUI(event, callerinfo)
    {
        let parts = callerinfo.split("|");
        let callerid = parts[0];
        let status = parts[1];
        let hash = parts[2];

        if (event == 'CALLER') {
            $('#callers').append("<div class='alert alert-light' id='call-"+hash+"'>Call from "+callerid+" <span class='queue badge badge-light'></span></div>");
        } else if (event == 'CALLERHANGUP') {
            $('#call-'+hash).remove();
            $('#connect-'+hash).remove();
        } else if (event == 'CALLERJOIN') {
            let call = $('#call-'+hash);

            if (call.length) {
                call.removeClass('alert-light').addClass('alert-primary');
                $('.queue', call).html(parts[3]);
            }
        }
    }

    function handleAgentUI(event, agentinfo)
    {
        let parts = agentinfo.split("|");

        let agentid = parts[0];
        let status = parts[1];

        let agdom = $('#agent-' + agentid);

        let agentsdom = $('#agents');

        if (!agdom.length && status != 'LOGGEDOUT') {
            agentsdom.append("<div class='alert alert-warning' id='agent-"+agentid+"'></div>");
            agdom = $('#agent-' + agentid);
        }

        switch (status) {
            case 'LOGGEDOUT':
                if (agdom.length) {
                    agdom.remove();
                }
                break;
            case 'LOGGEDIN':
                agdom.html(agentid + "  " + status + " <button class='btn btn-sm' onClick='javascript:goAvail(" + agentid + ")'>Go Avail</button>");
                agdom.removeClass('alert-success').addClass('alert-warning');
                break;
            case 'PAUSED':
                agdom.html(agentid + "  " + status + " <button class='btn btn-sm' onClick='javascript:changeStatus(" + agentid + ")'>Change</button>");
                agdom.removeClass('alert-success').addClass('alert-warning');
                break;
            case 'AVAIL':
                agdom.html(agentid + "  " + status + " <button class='btn btn-sm' onClick='javascript:changeStatus(" + agentid + ")'>Change</button>");
                agdom.removeClass('alert-warning').addClass('alert-success');

                conag = $('#connectedagent-'+agentid);

                if (conag.length) {
                    conag.remove();
                }
                break;
            default:
                agdom.html(agentid + "  " + status);
                agdom.removeClass('alert-success').addClass('alert-warning');
                break;
        }
    }


</script>

</body>
</html>
